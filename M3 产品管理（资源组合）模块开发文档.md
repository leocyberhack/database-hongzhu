# M3 产品管理（资源组合）模块开发文档

> 模块定位：OTA 套餐系统的**业务核心模块**
> 依赖关系：依赖 M2 资源库（Resource）+ M1 供应商管理（Supplier Resource 成本来源）
> 文档目标：把“资源如何组合成产品、如何避免重复、如何安全修改”一次性讲清楚

---

## 1. 模块定位与边界

### 1.1 模块解决的问题

* 将离散、可复用的资源组合成可售卖的产品（套餐）
* 明确“什么是一个唯一产品”，防止产品库失控
* 为商品、定价、库存提供**稳定、不易变形的产品底座**

### 1.2 模块不解决的问题

* 不处理渠道差异（由 M4 商品模块负责）
* 不直接管理库存与价格（由 M5/M6 承载）
* 不直接生成订单

> 产品模块只关心三件事：**组合结构、规则边界、生命周期**。

---

## 2. 核心设计原则（非常重要）

1. **产品唯一性 = 资源组合**
2. 不做父子产品、不做 SKU 层级
3. 历史不可破坏：

   * 已产生订单的产品，结构不可直接覆盖
4. 产品可以“下架”，但不删除
5. 产品是“稳定锚点”，商品/价格/库存围绕它变化

---

## 3. 核心概念

### 3.1 产品（Product）

* 定义：由一组资源及其数量/必选规则构成的套餐
* 示例：

  * 产品 A = 景区门票（成人） ×1 + 酒店标准间 ×1 晚
  * 产品 B = 景区门票（成人） ×1

### 3.2 产品结构快照（Product Snapshot）

* 用于锁定历史结构
* 防止修改影响历史订单

---

## 4. 数据模型设计（PGSQL）

### 4.1 产品主表 `product`

| 字段             | 类型          | 说明                 |
| -------------- | ----------- | ------------------ |
| id             | bigint PK   | 产品 ID              |
| product_name   | text        | 产品名称               |
| description    | text        | 产品描述               |
| status         | text        | 草稿 / 待审批 / 上架 / 下架 |
| structure_hash | text        | 资源组合指纹（用于判重）       |
| created_by     | text        | 创建人                |
| created_at     | timestamptz | 创建时间               |
| updated_at     | timestamptz | 更新时间               |

**关键约束**

* unique(structure_hash)

---

### 4.2 产品-资源组合表 `product_resource`

| 字段            | 类型        | 说明   |
| ------------- | --------- | ---- |
| id            | bigint PK | 主键   |
| product_id    | bigint FK | 产品   |
| resource_id   | bigint FK | 资源   |
| quantity      | int       | 数量   |
| required_flag | boolean   | 是否必选 |
| remark        | text      | 组合说明 |

---

### 4.3 产品结构快照表 `product_structure_snapshot`

> 在以下场景生成快照：
>
> * 产品首次上架
> * 产品结构发生变更（生成新产品）

| 字段            | 类型          | 说明       |
| ------------- | ----------- | -------- |
| id            | bigint PK   | 主键       |
| product_id    | bigint      | 对应产品     |
| snapshot_data | jsonb       | 资源组合完整快照 |
| created_at    | timestamptz | 创建时间     |

---

## 5. 产品唯一性与防重复机制（重点）

### 5.1 资源组合指纹（structure_hash）

生成规则（示例）：

```
resource_id:quantity:required_flag
按 resource_id 排序后拼接 → hash
```

说明：

* 顺序无关
* 数量/必选不同即视为不同产品

---

### 5.2 新建产品流程中的校验

1. 运营/产品经理选择资源并填写数量
2. 系统实时计算 structure_hash
3. 若命中已有产品：

   * 提示“系统已存在同款产品”
   * 引导：

     * 直接复用已有产品
     * 或明确确认创建新产品（强制）

---

## 6. 产品生命周期与状态机

### 6.1 状态定义

| 状态  | 说明          |
| --- | ----------- |
| 草稿  | 编辑中，不可被商品引用 |
| 待审批 | 提交审批中       |
| 上架  | 可被商品引用      |
| 下架  | 不可新售，但历史有效  |

---

### 6.2 状态流转

```
草稿 → 待审批 → 上架 → 下架
            ↘ 驳回 → 草稿
```

---

## 7. 产品创建与修改流程

### 7.1 新建产品

1. 创建产品（草稿）
2. 选择资源并设置数量/必选
3. 保存草稿（不生成快照）
4. 提交审批
5. 审批通过：

   * 生成 structure_snapshot
   * 状态变为“上架”

---

### 7.2 修改产品（重点规则）

**情况一：产品无历史订单**

* 允许直接修改资源组合
* 更新 structure_hash

**情况二：产品已有订单**

* 禁止直接修改资源组合
* 引导“复制为新产品”
* 原产品保持不变，仅可下架

---

## 8. 产品成本参考（与 M1 的关系）

### 8.1 成本计算逻辑（参考用）

* 产品成本 = Σ（资源数量 × 默认供给关系结算价）
* 仅作为参考展示
* 最终售价/利润由产品经理决定

---

## 9. 前端页面设计（后台）

### 9.1 页面结构

1. 产品列表页
2. 产品详情页
3. 新建/编辑产品页
4. 产品结构对比弹窗（旧 vs 新）

---

### 9.2 产品列表页

* 搜索：产品名 / 资源名
* 筛选：状态
* 展示：

  * 产品名
  * 资源数
  * 是否已有商品
  * 状态

---

### 9.3 产品编辑页（资源组合）

* 左侧：资源搜索（来自 M2）
* 右侧：已选资源列表
* 即时显示：

  * 资源组合明细
  * 成本参考（可折叠）

---

## 10. 异常与边界场景

1. 资源被停用：

* 不影响已有产品
* 新产品中禁止选择

2. 成本缺失：

* 产品仍可创建
* 成本参考区显示“缺失”标识

---

## 11. 与其他模块的数据契约

| 模块    | 关系                 |
| ----- | ------------------ |
| M4 商品 | 商品必须绑定已上架产品        |
| M5 定价 | 定价基于 SKU，不直接基于产品   |
| M6 库存 | 库存以 SKU 为粒度        |
| M7 订单 | 订单记录 product_id 快照 |

---

## 12. 可扩展方向（不影响一期）

* 行程结构（D1/D2）
* 可选资源 / 加购项
* 产品模板

---

> 设计总结：产品模块的首要目标不是“灵活”，而是“**不乱**”。资源组合一旦被售卖，就必须被系统牢牢锁住。
