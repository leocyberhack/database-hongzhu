# M2 资源库（POI & 资源）模块开发文档

> 模块定位：OTA 全链路系统最底层模块
> 依赖关系：**无前置依赖**（所有上层模块均依赖资源库）
> 文档目标：可直接用于数据库建模 + 后端接口设计 + 前端页面开发

---

## 1. 模块定位与设计边界

### 1.1 模块解决的问题

* 统一沉淀所有可售旅游服务资源
* 解决“同一资源被重复创建、无法复用”的问题
* 支撑：

  * 多供应商提供同类资源
  * 资源被多个产品复用
  * 资源字段高度不确定、持续演进

### 1.2 模块不解决的问题

* 不关心价格、库存、渠道
* 不关心是否真的被售卖
* 不处理订单与核销

> 资源库只回答一个问题：**“我们能提供什么服务单元？”**

---

## 2. 核心概念与分层模型

### 2.1 概念拆分

#### 2.1.1 POI（逻辑资源）

* 表示现实世界中的一个“服务对象”
* 示例：某景区、某酒店、某交通枢纽
* 用于去重与聚合

#### 2.1.2 Resource（可组合资源）

* 实际可被产品组合的最小单元
* 示例：

  * 景区 A 成人票
  * 酒店 B 豪华大床房

**一个 POI 可对应多个 Resource**

---

## 3. 数据模型设计（PGSQL）

### 3.1 POI 主表 `poi`

| 字段         | 类型        | 说明            |
| ---------- | --------- | ------------- |
| id         | bigint PK | 主键            |
| poi_name   | text      | POI 名称        |
| poi_type   | text      | 景区 / 酒店 / 餐厅等 |
| city       | text      | 城市            |
| address    | text      | 地址            |
| geo        | point     | 经纬度           |
| tags       | text[]    | 标签            |
| status     | text      | 启用/停用         |
| created_at | timestamp | 创建时间          |
| updated_at | timestamp | 更新时间          |

**约束设计**：

* (poi_name, city) 唯一索引（防止重复 POI）

---

### 3.2 资源表 `resource`

| 字段            | 类型        | 说明           |
| ------------- | --------- | ------------ |
| id            | bigint PK | 主键           |
| poi_id        | bigint FK | 所属 POI       |
| resource_name | text      | 资源名称         |
| resource_type | text      | 票 / 房 / 服务   |
| attrs         | jsonb     | 扩展属性         |
| status        | text      | 草稿 / 启用 / 停用 |
| created_at    | timestamp | 创建时间         |
| updated_at    | timestamp | 更新时间         |

**设计说明**：

* attrs 用于承载高度不确定字段（房型、票型、使用规则等）
* 不对 attrs 内容做强校验，仅做展示与筛选

---

### 3.3 资源标签表 `resource_tag`

| 字段          | 类型        | 说明 |
| ----------- | --------- | -- |
| id          | bigint PK | 主键 |
| resource_id | bigint FK | 资源 |
| tag         | text      | 标签 |

用途：

* 支撑快速筛选
* 支撑运营标注（热门/推荐/需补充）

---

## 4. 防重复与复用机制（核心）

### 4.1 新建 POI 时

* 实时模糊搜索（poi_name + city）
* 若命中：

  * 引导选择已有 POI
  * 禁止重复创建

### 4.2 新建 Resource 时

* 基于：poi_id + resource_type + 关键 attrs
* 提示“可能重复资源”，但允许强制创建（人工兜底）

---

## 5. 前端页面设计（后台）

### 5.1 页面结构

* 资源库首页（POI 列表）
* POI 详情页（资源列表）
* 资源详情页

### 5.2 核心交互

* 即输即搜（不回车）
* 多维筛选（类型 / 城市 / 标签）
* JSONB 字段只读 + 格式化展示

---

## 6. 与其他模块的关系

| 模块  | 关系                      |
| --- | ----------------------- |
| 供应商 | 通过 resource_supplier 关联 |
| 产品  | product_resource 引用     |
| 定价  | 不直接关联                   |
| 库存  | 不直接关联                   |

---

## 7. 异常与边界场景

* POI 被引用后禁止删除（仅停用）
* Resource 被产品引用后禁止删除
* 历史资源字段变更不影响历史订单

---

## 8. 可扩展方向（不影响一期）

* POI 合并 / 拆分
* 地图模式管理
* 资源标准化模板

---

> 本模块是整个 OTA 系统的地基，设计目标是：**宁可字段松，也不能结构乱；宁可慢建，也不能重复建**。
