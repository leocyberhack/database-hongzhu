# M1 供应商管理模块开发文档

> 模块定位：沉淀供应商主数据 + 维护“供应商提供哪些资源、以什么结算价/规则提供”的供给关系
> 依赖关系：依赖 M2 资源库（Resource/POI 已存在）
> 本期原则：不做复杂结算系统；但要把**结算基础信息、结算价、供给可用性**沉淀下来，为定价/利润/报表服务

---

## 1. 模块边界与目标

### 1.1 模块解决的问题

* 统一管理供应商主档案（联系人、资质、合作状态等）
* 将“供应商-资源”的供给关系结构化：

  * 哪些资源由哪些供应商提供
  * 结算价（成本价）维护
  * 供给状态（可用/停用）
  * 供给规则（库存口径、可售说明等）
* 支撑后续：

  * 产品成本估算（资源成本聚合）
  * 渠道利润核算（订单成本/利润）
  * 供应商备选（同资源多供应商）

### 1.2 模块不解决的问题

* 不做对账单、账期结算、付款流程
* 不对接供应商库存/价格接口（本期人工维护）
* 不做合同审批流（可先用附件字段沉淀）

---

## 2. 核心概念

### 2.1 供应商（Supplier）

* 定义：景区/酒店/交通/餐厅等直接服务提供方
* 生命周期：潜在 → 合作中 → 暂停合作 → 终止

### 2.2 供给关系（Supply Relationship）

* 定义：供应商与资源之间的一条“能供给”关系
* 一条供给关系包含：

  * 结算价（可按版本/时间段扩展）
  * 供给状态
  * 供给说明（库存口径、适用日期、备注）

> 资源是可复用的底座；供给关系让资源“可用且有成本”。

---

## 3. 角色与权限（本模块）

* 管理员：供应商新增/编辑/停用、供给关系全权限
* 运营：可新增供给关系、维护结算价（需走审批：见 M8/M5 的统一审批）
* 产品经理：可查看、可发起调价/变更供给（审批人）
* 财务：只读 + 导出（成本/结算信息）
* 管理层：只读统计

> 关键点：本模块产生的“结算价”会影响利润与报表，建议纳入审批（具体审批实现放在 M8）。

---

## 4. 数据模型设计（PGSQL）

### 4.1 供应商主表 `supplier`

| 字段                  | 类型          | 说明                    |
| ------------------- | ----------- | --------------------- |
| id                  | bigint PK   | 主键                    |
| supplier_name       | text        | 供应商名称（展示名）            |
| supplier_type       | text        | 景区/酒店/交通/餐饮/玩乐/其他     |
| status              | text        | 潜在/合作中/暂停/终止          |
| contact_info        | jsonb       | 联系人、电话、邮箱、地址等         |
| settlement_info     | jsonb       | 结算信息（开户行、账号、税号、开票信息等） |
| qualification_files | jsonb       | 资质/证照/合同附件（文件元信息）     |
| tags                | text[]      | 标签（重点/风险/需跟进等）        |
| remark              | text        | 备注                    |
| created_at          | timestamptz | 创建时间                  |
| updated_at          | timestamptz | 更新时间                  |

**索引/约束建议**

* unique: supplier_name（可选：若存在同名风险则改为 name + phone/email 去重）
* idx: supplier_type, status
* gin: tags

---

### 4.2 供应商-资源供给关系表 `supplier_resource`

> 一条记录代表：某供应商提供某资源（M2.resource），并给出成本/规则。

| 字段               | 类型            | 说明                 |
| ---------------- | ------------- | ------------------ |
| id               | bigint PK     | 主键                 |
| supplier_id      | bigint FK     | 供应商                |
| resource_id      | bigint FK     | 资源                 |
| supply_status    | text          | 可供/暂停/不可供          |
| settlement_price | numeric(12,2) | 当前默认结算价（成本价）       |
| currency         | text          | 币种（一期可默认 CNY）      |
| rule             | jsonb         | 供给规则（库存口径、适用范围、备注） |
| priority         | int           | 供应优先级（用于备选）        |
| created_at       | timestamptz   | 创建时间               |
| updated_at       | timestamptz   | 更新时间               |

**约束**

* unique (supplier_id, resource_id)

**索引**

* idx: resource_id
* idx: supplier_id
* idx: supply_status

---

### 4.3 结算价历史表 `supplier_resource_price_history`

> 原则：结算价影响利润/报表，必须留痕；本表用于记录供给关系下的结算价变更。

| 字段                   | 类型            | 说明          |
| -------------------- | ------------- | ----------- |
| id                   | bigint PK     | 主键          |
| supplier_resource_id | bigint FK     | 对应供给关系      |
| before_price         | numeric(12,2) | 变更前         |
| after_price          | numeric(12,2) | 变更后         |
| reason               | text          | 变更原因        |
| operator             | text          | 操作人         |
| operated_at          | timestamptz   | 操作时间        |
| approval_id          | bigint        | 关联审批（若启用审批） |

**索引**

* idx: supplier_resource_id, operated_at desc

---

### 4.4 供应商附件（可选增强）`supplier_attachment`

> 若你们附件量大/需要权限隔离，建议拆表；否则也可以继续放 supplier.qualification_files。

| 字段          | 类型          | 说明           |
| ----------- | ----------- | ------------ |
| id          | bigint PK   | 主键           |
| supplier_id | bigint FK   | 供应商          |
| file_name   | text        | 文件名          |
| file_key    | text        | 存储 key       |
| file_type   | text        | 合同/资质/报价单/其他 |
| uploaded_by | text        | 上传人          |
| uploaded_at | timestamptz | 上传时间         |

---

## 5. 关键业务流程

### 5.1 新建供应商

1. 运营/管理员进入【供应商列表】→【新建】
2. 填写：名称、类型、联系人、状态（默认：潜在）
3. 上传附件（合同/资质等，可选）
4. 保存

**校验**

* 同名提示：若 supplier_name 已存在，提示可能重复（允许强制创建/或改为合并）

---

### 5.2 给供应商绑定资源（创建供给关系）

1. 进入供应商详情页 →【供给资源】tab →【新增供给】
2. 选择资源：从 M2 资源库搜索选择（支持模糊搜）
3. 填写默认结算价 settlement_price
4. 填写供给规则 rule（JSONB 表单化录入，字段见 5.4）
5. 保存（若结算价需审批：状态进入“待审批”，审批通过后生效）

**防重**

* 若 (supplier_id, resource_id) 已存在：禁止创建，提示改为编辑

---

### 5.3 变更结算价（成本价）

1. 在供给关系详情/列表直接点【调价】
2. 输入新价格、原因、（可选）生效时间
3. 系统写入 price_history
4. 若开启审批：生成审批单，审批通过后更新 supplier_resource.settlement_price

**约束**

* 不允许直接覆盖不留痕

---

### 5.4 供给规则 rule（JSONB）建议字段

> 一期不做强校验，但建议 UI 表单化，便于查询。

建议键：

* inventory_granularity：库存粒度（日期/场次/房晚/名额…）
* inventory_source：库存来源（平台维护/供应商报数）
* usable_date_range：适用日期范围
* blackout_dates：不可用日期
* notes：备注

---

## 6. 前端页面与交互（后台管理端）

### 6.1 页面清单

1. 供应商列表页
2. 供应商详情页（基础信息 + 附件 + 供给资源 tab）
3. 新建/编辑供应商
4. 新增/编辑供给关系（绑定资源）
5. 结算价历史弹窗/页面

### 6.2 列表页（供应商）

* 搜索：名称关键词（实时）
* 筛选：类型、状态、标签
* 排序：更新时间、创建时间
* 操作：新建、停用/启用、导出

### 6.3 供应商详情页

* 基础信息卡片
* 附件区（合同/资质/报价单）
* 供给资源表格：

  * resource_name
  * resource_type
  * settlement_price
  * supply_status
  * priority
  * 操作：编辑、调价、停用

### 6.4 导入/导出

* 导出：供应商清单、供给关系清单
* 导入（增强）：支持 CSV 导入供给关系（supplier_name + resource_id/资源名匹配 + settlement_price）

---

## 7. 异常与边界场景

1. 供应商停用：

* 不能删除（保留历史订单/成本追溯）
* 停用后：不允许新建供给关系、不允许用于新产品成本计算（上层模块可过滤）

2. 资源停用：

* 供给关系仍保留，但供给状态强制不可供

3. 价格为空：

* 允许 supply 关系存在但 settlement_price 为空（代表“未录入成本”）
* 上层利润报表应提示“成本缺失”并单独统计

---

## 8. 与其他模块的接口约定（数据契约）

### 8.1 向 M3 产品模块提供

* 产品组合资源后，若需要成本估算：

  * 通过 resource_id 找到可供的 supplier_resource
  * 依据 priority 或人工指定供应商

### 8.2 向 M5 定价模块提供

* cost_price 的来源：

  * 默认来自 supplier_resource.settlement_price 聚合
  * 允许人工覆盖（最终以产品经理为准）

### 8.3 向 M7 订单模块提供

* 订单成本 cost_amount：

  * 可由下单时选定的成本价写入
  * 或由运营录入时填写

---

## 9. 可扩展方向（不影响一期）

* 供应商分层（旅行社/地接/票务代理等）
* 账期与结算单模块（本期不做）
* 供应商接口对接库存/价格（未来）
* 供应商评分与履约质量（核销率/退款率）

---

> 设计总结：本模块要保证“资源有来源、成本有出处、变更可追溯”，为定价、库存、订单、报表提供可靠底座。
