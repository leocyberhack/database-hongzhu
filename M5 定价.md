# M5 定价（价格 / 价格历史 / 审批）模块开发文档

> 模块定位：SKU 售卖价格的**唯一权威来源**
> 依赖关系：依赖 M4 商品（SKU）模块；成本参考来自 M1 供应商管理
> 设计目标：价格**可控、可追溯、可回滚**，避免任何“直接覆盖价格”的行为

---

## 1. 模块边界与设计原则

### 1.1 模块解决的问题

* 维护 SKU 在不同渠道下的销售价格
* 明确价格生效区间（时间维度）
* 支撑人工定价 + 审批，而非自动算价
* 为利润、报表、订单提供稳定价格来源

### 1.2 模块不解决的问题

* 不负责库存数量（M6）
* 不生成订单（M7）
* 不做动态定价/自动调价

---

## 2. 核心设计原则（非常关键）

1. **价格不可被直接覆盖**，只能新增/失效
2. **任何价格变更都必须留历史**
3. **最终定价权在人，不在规则**
4. 同一 SKU + 渠道 + 时间段，只能有一个生效价格
5. 价格是订单利润计算的“事实来源”

---

## 3. 核心概念

### 3.1 销售价（Sale Price）

* 用户在渠道看到并支付的价格

### 3.2 成本价（Cost Price）

* 参考值，默认来自 M1 供应商供给关系
* 允许人工覆盖（最终以订单记录为准）

### 3.3 价格版本（Price Version）

* 一条价格记录 = 一个版本
* 版本之间通过时间区间区分

---

## 4. 数据模型设计（PGSQL）

### 4.1 价格主表 `price`

| 字段         | 类型            | 说明                  |
| ---------- | ------------- | ------------------- |
| id         | bigint PK     | 价格 ID               |
| sku_id     | bigint FK     | SKU                 |
| channel_id | bigint FK     | 渠道                  |
| sale_price | numeric(12,2) | 销售价                 |
| cost_price | numeric(12,2) | 成本价（参考）             |
| start_at   | date          | 生效开始日期              |
| end_at     | date          | 生效结束日期              |
| status     | text          | 草稿 / 待审批 / 生效 / 已失效 |
| created_by | text          | 创建人                 |
| created_at | timestamptz   | 创建时间                |
| updated_at | timestamptz   | 更新时间                |

**关键约束**

* 同一 sku_id + channel_id + 时间区间 不允许重叠

---

### 4.2 价格历史表 `price_history`

> 记录“一次价格操作”的前后差异，而非简单复制 price 表

| 字段          | 类型          | 说明   |
| ----------- | ----------- | ---- |
| id          | bigint PK   | 主键   |
| price_id    | bigint FK   | 对应价格 |
| before_data | jsonb       | 变更前  |
| after_data  | jsonb       | 变更后  |
| operator    | text        | 操作人  |
| operated_at | timestamptz | 操作时间 |
| approval_id | bigint      | 关联审批 |

---

### 4.3 价格冲突检测视图（建议）

```sql
-- 检测同一 SKU + 渠道 的时间重叠价格
```

---

## 5. 价格生命周期与状态机

### 5.1 状态定义

| 状态  | 含义      |
| --- | ------- |
| 草稿  | 编辑中，不生效 |
| 待审批 | 等待审批    |
| 生效  | 当前可用    |
| 已失效 | 历史版本    |

---

### 5.2 状态流转

```
草稿 → 待审批 → 生效 → 已失效
            ↘ 驳回 → 草稿
```

---

## 6. 关键业务流程

### 6.1 新建价格

1. 选择 SKU + 渠道
2. 系统自动带出参考成本价（来自 M1）
3. 输入销售价、生效日期
4. 保存为草稿
5. 提交审批

校验：

* 生效区间不能与已有生效价格重叠

---

### 6.2 调价流程（核心）

> 本质：新增一个价格版本 + 让旧版本失效

1. 在 SKU 价格列表点击【调价】
2. 系统复制当前生效价格为新草稿
3. 修改 sale_price / cost_price / 时间
4. 提交审批
5. 审批通过：

   * 新版本 status=生效
   * 原版本 status=已失效（end_at = 新 start_at - 1）
   * 写入 price_history

---

### 6.3 价格回滚

* 选择历史 price 版本
* 新建一个“回滚版本”（而非复活旧记录）
* 走完整审批流程

---

## 7. 前端页面与交互设计

### 7.1 页面清单

1. SKU 价格列表页
2. 新建 / 编辑价格页
3. 价格历史弹窗

---

### 7.2 SKU 价格列表页

* 展示维度：

  * 渠道
  * 生效区间
  * 销售价 / 成本价
  * 状态
* 操作：

  * 新建价格
  * 调价
  * 查看历史

---

### 7.3 新建 / 调价页

* 字段：

  * SKU（只读）
  * 渠道
  * 销售价
  * 成本价（可改，标注“参考”）
  * 生效区间
* 即时校验：

  * 时间冲突提示

---

## 8. 异常与边界场景

1. SKU 下架：

* 已生效价格不删除
* 不允许新建价格

2. 渠道停用：

* 价格保持历史状态

3. 成本缺失：

* 允许定价
* 报表中单独标记“成本缺失订单”

---

## 9. 与其他模块的数据契约

| 模块    | 使用方式                          |
| ----- | ----------------------------- |
| M6 库存 | 上架前校验是否有生效价格                  |
| M7 订单 | 下单时写入 sale_price / cost_price |
| M9 报表 | 以订单记录价格为准                     |
| M8 审批 | 所有价格变更走统一审批                   |

---

## 10. 可扩展方向（不影响一期）

* 多币种定价
* 阶梯价 / 人数价
* 渠道专属折扣

---

> 设计总结：价格模块的第一目标不是“算得聪明”，而是“**不出事故**”。价格一旦被覆盖而无法追溯，系统就失去了财务与管理价值。
