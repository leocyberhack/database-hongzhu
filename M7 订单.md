# M7 订单 / 核销 / 退款模块开发文档

> 模块定位：销售事实的**最终来源**，驱动库存与经营指标
> 依赖关系：依赖 M4 SKU & 渠道、M5 定价、M6 库存
> 设计目标：订单**事实化、可追溯、可人工处理**，不追求实时自动化

---

## 1. 模块边界与目标

### 1.1 模块解决的问题

* 记录渠道产生的订单事实（人工录入 / Excel 导入）
* 在订单层**写死价格与成本**，作为后续统计与对账依据
* 驱动库存冻结、核销与退款解冻
* 统一核销口径，支撑核销率、利润等指标

### 1.2 模块不解决的问题

* 不对接支付网关（默认订单已支付）
* 不做复杂售后规则引擎
* 不做渠道 API 实时回流

> 本模块只做一件事：**把“卖了什么、卖给谁、卖了多少钱、是否已核销”记成事实**。

---

## 2. 核心设计原则（关键）

1. **订单一旦创建，价格不可变**（只能通过退款体现）
2. **库存变化必须由订单驱动**（冻结/核销/解冻）
3. **核销是经营指标的核心事实**
4. 人工操作允许，但必须留痕
5. 历史订单不可删除，只能状态演进

---

## 3. 核心概念

### 3.1 订单（Order）

* 定义：某 SKU 在某渠道的一次销售记录
* 一条订单对应一个 SKU（不做多 SKU 订单）

### 3.2 核销（Verification）

* 定义：确认服务已履约
* 不区分核销方（统一由平台录入）

### 3.3 退款（Refund）

* 定义：未核销订单的取消行为
* 通过订单状态体现，不拆独立退款单

---

## 4. 数据模型设计（PGSQL）

### 4.1 订单主表 `order`

| 字段            | 类型            | 说明              |
| ------------- | ------------- | --------------- |
| id            | bigint PK     | 订单 ID           |
| order_no      | text          | 外部订单号 / 人工编号    |
| channel_id    | bigint FK     | 渠道              |
| sku_id        | bigint FK     | SKU             |
| product_id    | bigint FK     | 产品（冗余快照）        |
| travel_date   | date          | 出行/使用日期         |
| quantity      | int           | 数量（默认 1）        |
| sale_price    | numeric(12,2) | 成交单价            |
| sale_amount   | numeric(12,2) | 成交总额            |
| cost_price    | numeric(12,2) | 成本单价            |
| cost_amount   | numeric(12,2) | 成本总额            |
| profit_amount | numeric(12,2) | 利润（冗余）          |
| status        | text          | 已支付 / 已核销 / 已退款 |
| created_by    | text          | 录入人             |
| created_at    | timestamptz   | 创建时间            |
| verified_at   | timestamptz   | 核销时间            |
| refunded_at   | timestamptz   | 退款时间            |
| remark        | text          | 备注              |

**关键约束**

* order_no + channel_id 唯一（防重复导入）
* sale_amount = sale_price × quantity（写入时校验）

---

### 4.2 订单状态历史表 `order_status_history`

| 字段            | 类型          | 说明 |
| ------------- | ----------- | -- |
| id            | bigint PK   |    |
| order_id      | bigint FK   |    |
| before_status | text        |    |
| after_status  | text        |    |
| operator      | text        |    |
| operated_at   | timestamptz |    |
| reason        | text        |    |

---

## 5. 订单状态机

### 5.1 状态定义

| 状态  | 含义        |
| --- | --------- |
| 已支付 | 已售出，库存已冻结 |
| 已核销 | 已履约，库存已扣减 |
| 已退款 | 未履约，库存已解冻 |

---

### 5.2 状态流转

```
已支付 → 已核销
    ↘
     已退款
```

> 不支持：已核销 → 已退款（一期）

---

## 6. 关键业务流程

### 6.1 新增订单（人工录入 / 导入）

1. 选择渠道、SKU
2. 选择出行日期
3. 系统自动读取：

   * 当前生效价格（M5）
   * 成本参考（M1 / M5）
4. 填写数量、确认金额
5. 保存订单
6. 触发库存冻结（M6）

---

### 6.2 订单核销

前置校验：

* 订单状态 = 已支付
* 对应库存 frozen_qty ≥ quantity

操作：

* 更新订单状态 → 已核销
* 写 verified_at
* 触发库存：冻结 → 已售

---

### 6.3 订单退款

前置校验：

* 订单状态 = 已支付

操作：

* 更新订单状态 → 已退款
* 写 refunded_at
* 触发库存：解冻

---

## 7. 前端页面与交互设计

### 7.1 页面清单

1. 订单列表页
2. 新建订单 / 导入订单
3. 订单详情页
4. 核销 / 退款操作弹窗

---

### 7.2 订单列表页

* 搜索：订单号 / SKU / 产品
* 筛选：渠道 / 状态 / 日期
* 展示：

  * 订单号
  * SKU / 产品
  * 出行日期
  * 金额 / 利润
  * 状态

---

### 7.3 新建订单页

* SKU、渠道选择联动
* 自动带出价格（可人工修正，但写入订单后不可改）
* 明确提示：订单创建后价格不可修改

---

## 8. 异常与边界场景

1. 重复导入订单：

* 命中唯一约束，提示忽略/更新

2. 库存不足：

* 禁止创建订单

3. 成本缺失：

* 允许创建订单
* 利润字段标记异常

---

## 9. 与其他模块的数据契约

| 模块    | 关系                |
| ----- | ----------------- |
| M6 库存 | 创建→冻结；核销→扣减；退款→解冻 |
| M9 报表 | 所有经营指标来源          |
| M8 审计 | 所有状态变化写审计         |

---

## 10. 可扩展方向（不影响一期）

* 多 SKU 订单
* 改期 / 部分退款
* 核销码 / 二维码

---

> 设计总结：订单模块是“事实层”，一旦写入就不应被随意修改。宁可流程慢一点，也不要让历史数据变得不可信。
