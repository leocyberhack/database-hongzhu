# OTA 全链路垂直数据库与后台产品开发文档（PGSQL · 细化版）

> 适用对象：OTA 旅行平台（线上旅行套餐售卖，人工录入/导入为主）
> 技术栈：PostgreSQL + Python（后端）+ 现代前端管理后台
> 文档目标：**不偏概念、不留空白，可直接拆表、拆接口、拆页面开发**

---

## 1. 项目背景与总体目标

### 1.1 业务背景

公司为 OTA 旅行平台，核心业务为：

* 从 **供应商** 获取各类旅游服务资源（景区、酒店、交通等）
* 将资源沉淀为可复用的 **资源库（POI 级别）**
* 通过资源组合形成 **产品（套餐）**
* 针对不同 **渠道** 将产品包装为 **商品（SKU）** 对外售卖
* 销售数据、订单、核销结果主要来自 **人工录入 / Excel 导入**

当前主要问题：

* 产品、商品、资源、渠道关系复杂，靠表格难以长期维护
* 定价、库存、审批缺乏统一数据模型
* 管理层无法稳定看到统一口径的销售 / 利润 / 核销数据

### 1.2 建设目标

* 建立一套 **供应商 → 资源 → 产品 → 商品 → 渠道 → 销售运营** 的全链路数据库
* 支撑多渠道、多价格、多库存、多商品形态
* 强调 **人工可控 + 审计可追溯**，弱化自动化依赖
* 一期即可上线，后续扩展不推翻结构

### 1.3 核心设计原则

1. **领域拆分清晰**：每一层对象边界明确，不混用
2. **组合即唯一**：产品唯一性由资源组合决定
3. **价格与库存强留痕**：不允许“直接改、无记录”
4. **以人决策为核心**：系统辅助，不替人拍板
5. **读写分离 + 防误操作 UX**：避免运营误点造成事故

---

## 2. 核心业务对象与名词定义（统一口径）

### 2.1 供应商（Supplier）

**定义**：直接提供旅游服务能力的一方。

* 类型示例：景区方 / 酒店 / 餐厅 / 交通公司 / 本地玩乐商家
* 不等同于“旅行社售卖方”

**核心特性**：

* 一个供应商可提供多个资源
* 一个资源概念可对应多个供应商（比价 / 备选）

---

### 2.2 资源（Resource）

**定义**：最小可被产品组合的服务单元。

示例：

* 景区 A 的「成人票」
* 酒店 B 的「豪华大床房」
* 一次接送服务

**资源层关注的是“能提供什么”**，不关心卖给谁、怎么卖。

**关键特征**：

* 以 POI / 资源库 为中心
* 支持多供应商挂接
* 字段高度不确定，必须支持扩展

---

### 2.3 产品（Product）

**定义**：由一种或多种资源组合而成的套餐。

规则说明：

* 产品唯一性 = 资源组合本身
* 不存在父子产品 / 主从产品
* 资源 A + B 与 A + B + C 必然是两个不同产品
* 单一资源也可直接形成产品

**产品是“业务售卖逻辑的核心”**，承载：

* 组合关系
* 基础规则
* 价格与库存的承载主体

---

### 2.4 商品（SKU / Goods）

**定义**：产品在某一渠道、某一规则下的具体售卖形态。

示例：

* 产品 X → 抖音工作日商品
* 产品 X → 抖音节假日商品
* 产品 X → 美团商品

**特性**：

* 一个产品可对应多个商品
* 商品不直接关心资源组合，只关心“卖什么价格、卖给谁”

---

### 2.5 渠道（Channel）

**定义**：实际发生销售行为的平台。

支持：

* 主渠道：抖音 / 美团 / 携程 / 飞猪 / 小红书 / 微信小程序
* 子渠道：门店、账号、团长、城市

---

### 2.6 订单（Order）

**定义**：某商品在某渠道产生的一笔销售记录。

特点：

* 可人工录入或导入
* 不追求实时
* 是所有经营指标的最终数据源

---

## 3. 总体模块拆分

1. 供应商管理模块
2. 资源库（POI）模块
3. 产品管理（资源组合）模块
4. 商品与渠道管理模块
5. 定价与价格历史模块
6. 库存管理模块
7. 订单 / 核销 / 退款模块
8. 审批流与审计日志模块
9. 报表与经营看板模块

---

## 4. 数据模型设计（PGSQL · 领域拆表）

> 说明：以下为一期核心表，字段允许中英混合，扩展字段统一使用 JSONB

### 4.1 供应商表 `supplier`

* id (PK)
* supplier_name
* supplier_type
* contact_info JSONB
* settlement_info JSONB
* status
* created_at / updated_at

---

### 4.2 资源主表 `resource`

* id (PK)
* resource_name
* resource_type
* poi_name
* attrs JSONB （扩展字段，如房型、票种、使用规则）
* status
* created_at / updated_at

### 4.3 资源-供应商关系表 `resource_supplier`

* id
* resource_id (FK)
* supplier_id (FK)
* settlement_price
* inventory_rule JSONB
* status

---

### 4.4 产品表 `product`

* id
* product_name
* description
* status（草稿 / 待审批 / 已上架 / 已下架）
* created_by
* created_at / updated_at

### 4.5 产品-资源组合表 `product_resource`

* id
* product_id
* resource_id
* quantity
* required_flag

---

### 4.6 商品表 `sku`

* id
* product_id
* sku_name
* sale_start / sale_end
* travel_start / travel_end
* status

---

### 4.7 渠道表 `channel`

* id
* channel_name
* parent_id
* attrs JSONB

### 4.8 商品-渠道关系 `sku_channel`

* id
* sku_id
* channel_id
* status

---

### 4.9 定价表 `price`

* id
* sku_id
* channel_id
* cost_price
* sale_price
* start_at / end_at
* status
* created_by

### 4.10 价格历史表 `price_history`

* id
* price_id
* before_data JSONB
* after_data JSONB
* operator
* operated_at

---

### 4.11 库存表 `inventory`

* id
* sku_id
* inventory_date
* total_qty
* sold_qty
* frozen_qty

库存规则：

* 支付成功 → 冻结
* 核销 → 扣减
* 退款 → 解冻
* 不允许超卖

---

### 4.12 订单表 `order`

* id
* channel_id
* sku_id
* sale_amount
* cost_amount
* profit_amount
* order_status（已支付/已核销/已退款）
* order_time
* verify_time

---

### 4.13 审批表 `approval`

* id
* object_type
* object_id
* action_type
* status
* approver
* created_at

---

### 4.14 审计日志表 `audit_log`

* id
* table_name
* record_id
* diff JSONB
* operator
* operated_at

---

## 5. 关键业务流程说明

### 5.1 产品上新流程

1. 创建 / 选择资源
2. 组合生成产品（草稿）
3. 创建商品（SKU）
4. 设置价格
5. 提交审批
6. 审批通过后上架

### 5.2 定价与审批

* 所有价格变更必须走审批
* 历史价格不可删除，仅失效

### 5.3 库存流程

* 初始化库存
* 销售后冻结
* 核销扣减
* 退款解冻

---

## 6. 报表与经营看板设计

### 6.1 管理层经营看板

* 日 / 周 / 月：销售额、利润、订单数
* 利润率、核销率
* 客单价、退款率
* Top 商品 / Top 渠道

### 6.2 运营看板

* 缺库存预警
* 待审批事项
* 异常商品（低核销率 / 异常利润）

### 6.3 产品看板

* 待审批产品
* 调价影响预估
* 资源组合重复提醒

---

## 7. 权限与角色

* 管理层：只读经营数据
* 运营：商品、库存、订单
* 产品经理：产品、定价、审批
* 财务：成本、利润、对账
* 管理员：系统管理

---

## 8. 非功能与技术要求

* PostgreSQL 全文检索（实时关键词搜索）
* 读写分离
* 每日备份（保留 3 天）
* 全量审计日志（保留 30 天，可下载）

---

## 9. 后续扩展方向

* 渠道 API 自动对接
* 自动库存同步
* 供应商结算与对账
* BI 数据仓库 / 指标中心

---

> 本文档为 OTA 全链路垂直系统的一期完整设计蓝本，可直接指导数据库建模与后台开发。
