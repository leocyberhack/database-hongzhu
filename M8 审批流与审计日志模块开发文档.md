# M8 审批流与审计日志模块开发文档

> 模块定位：全系统的**安全阀与追责底座**
> 依赖关系：横向依赖 M1–M7 所有业务模块
> 设计目标：关键操作**先审批、全留痕、可追溯、可还原**，但不过度打断日常运营效率

---

## 1. 模块定位与设计哲学

### 1.1 模块解决的问题

* 为高风险业务操作提供统一审批机制
* 为所有关键数据变更提供审计留痕
* 支撑事后复盘、问题定位、责任界定

### 1.2 模块不解决的问题

* 不做复杂 BPM / 流程编排
* 不做组织与权限系统（仅消费权限结果）
* 不参与业务规则计算

> 设计哲学：**能不审批就不审批，一旦审批必须说得清楚**。

---

## 2. 哪些操作必须走审批（一期硬规则）

### 2.1 必须审批的操作

| 模块     | 操作             | 风险说明      |
| ------ | -------------- | --------- |
| M3 产品  | 产品首次上架 / 下架    | 决定可售边界    |
| M4 SKU | SKU 上架 / 下架    | 实际可卖性     |
| M5 定价  | 新建价格 / 调价 / 回滚 | 直接影响收入    |
| M6 库存  | 人工调整库存         | 超卖 / 少卖风险 |
| M1 供应商 | 结算价变更          | 影响成本与利润   |

### 2.2 不需要审批的操作（示例）

* 草稿态编辑
* 标签、备注类字段修改
* 查询、导出

---

## 3. 审批模型（统一抽象）

### 3.1 核心概念

* **审批单（Approval）**：一次审批请求
* **审批对象（Object）**：被操作的业务实体
* **审批动作（Action）**：上架 / 调价 / 调整库存等

审批模块不关心业务细节，仅决定是否放行。

---

## 4. 数据模型设计（PGSQL）

### 4.1 审批主表 `approval`

| 字段          | 类型          | 说明                                           |
| ----------- | ----------- | -------------------------------------------- |
| id          | bigint PK   | 审批单 ID                                       |
| object_type | text        | product / sku / price / inventory / supplier |
| object_id   | bigint      | 业务对象 ID                                      |
| action_type | text        | 操作类型                                         |
| before_data | jsonb       | 变更前快照                                        |
| after_data  | jsonb       | 变更后快照                                        |
| status      | text        | 待审批 / 通过 / 驳回                                |
| applicant   | text        | 申请人                                          |
| approver    | text        | 审批人                                          |
| applied_at  | timestamptz | 提交时间                                         |
| decided_at  | timestamptz | 决策时间                                         |
| comment     | text        | 审批意见                                         |

---

### 4.2 审计日志表 `audit_log`

> 系统级不可变日志，只追加、不修改、不删除

| 字段          | 类型          | 说明                              |
| ----------- | ----------- | ------------------------------- |
| id          | bigint PK   | 日志 ID                           |
| table_name  | text        | 表名                              |
| record_id   | bigint      | 记录 ID                           |
| operation   | text        | INSERT / UPDATE / STATUS_CHANGE |
| diff_data   | jsonb       | 字段级差异                           |
| operator    | text        | 操作人                             |
| operated_at | timestamptz | 操作时间                            |
| source      | text        | 页面 / API / 导入                   |

**规则**：

* 默认保存 30 天
* diff_data 仅存变化字段

---

## 5. 审批与业务数据的关系

* 审批表 ≠ 业务表
* 审批通过后：

  * 写入目标业务表
  * 同时生成一条 audit_log
* 审批驳回：

  * 不影响业务表
  * 仅记录审批结果

---

## 6. 审批流程（统一模型）

```
业务操作 → 生成审批单 → 审批人处理
                   ↓
        通过 → 写业务表 + 写审计日志
        驳回 → 状态回退 + 留审批记录
```

---

## 7. 审批状态机

| 状态  | 含义     |
| --- | ------ |
| 待审批 | 等待处理   |
| 通过  | 已放行并生效 |
| 驳回  | 已拒绝    |

---

## 8. 审计日志触发点（全系统）

必须记录审计日志的操作：

* 所有审批通过的操作
* 所有库存数量变化
* 所有订单状态变化
* 所有价格状态变化
* 所有 SKU / 产品 上下架

---

## 9. 前端页面与交互设计

### 9.1 页面清单

1. 我的待审批
2. 审批详情页
3. 审批历史
4. 审计日志查询

### 9.2 审批详情页

* 操作摘要
* before / after JSON diff 高亮对比
* 审批意见
* 通过 / 驳回操作

### 9.3 审计日志页

* 按表名 / 对象 / 操作人 / 时间筛选
* 支持导出 JSON / CSV

---

## 10. 异常与边界场景

1. 审批人缺失：禁止提交审批
2. 审批超时：不自动通过，由管理员处理
3. 数据不一致：以业务表为准，日志仅追溯

---

## 11. 可扩展方向（不影响一期）

* 多级审批
* 金额阈值审批
* 自动审批规则

---

> 设计总结：审批与审计模块不是为了“卡流程”，而是为了让系统在出问题时，有证据、有边界、说得清楚。
