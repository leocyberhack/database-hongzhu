# M9 报表与经营看板模块开发文档

> 模块定位：经营数据输出层（老板/产品/运营的“真相”入口）
> 依赖关系：依赖 M7 订单（事实层），辅以 M6 库存、M5 定价历史（可选）、M4 渠道/SKU维表
> 设计目标：统一指标口径、可解释、可追溯、可导出；不做外部 BI，对内“够用且可信”

---

## 1. 模块边界与设计原则

### 1.1 模块解决的问题

* 提供管理层/运营/产品的看板与报表
* 将“销售额/利润/核销率/利润率/订单数”等核心指标固化为统一口径
* 支持按：日/周/月、渠道、SKU、产品、城市（若可得）等维度切分
* 支持导出（CSV/Excel）与定时截图（可选）

### 1.2 模块不解决的问题

* 不做复杂预测模型
* 不做多维立方体/数据仓库（未来可扩展）
* 不做外部渠道实时拉取

---

## 2. 指标设计哲学（必须写死）

1. **订单是事实层**：所有经营统计以 `order` 表为准
2. **价格不回算**：利润以订单写入的 sale/cost 为准
3. **核销率以订单状态为准**（已核销 / 总订单）
4. 指标必须可解释：每个数字都能 drill-down 到订单明细

---

## 3. 指标字典（Metric Dictionary）

> 默认提供三套看板：管理层（结果）、运营（风险/待办）、产品（变更/效率）

### 3.1 管理层经营指标（默认展示）

**时间维度**：日 / 周 / 月（可切换）

| 指标          | 口径定义                        | 数据来源  |
| ----------- | --------------------------- | ----- |
| 销售额（GMV/实收） | Σ order.sale_amount         | order |
| 利润          | Σ order.profit_amount       | order |
| 订单数         | count(*)                    | order |
| 核销订单数       | count(status='已核销')         | order |
| 核销率         | 核销订单数 / 订单数                 | order |
| 利润率         | 利润 / 销售额                    | order |
| 客单价         | 销售额 / 订单数                   | order |
| 退款订单数       | count(status='已退款')         | order |
| 退款率         | 退款订单数 / 订单数                 | order |
| 未核销金额占比     | Σ(已支付未核销 sale_amount) / 销售额 | order |

> 注：若你们希望区分 GMV vs 实收，可在订单新增字段（如 paid_amount）后扩展。

---

### 3.2 运营看板指标（默认展示）

| 指标       | 口径/说明                  | 数据来源      |
| -------- | ---------------------- | --------- |
| 缺库存预警数   | 未来 N 天剩余库存≤阈值 的 SKU 数  | inventory |
| 待审批数     | status=待审批 的审批单数量      | approval  |
| 异常核销 SKU | 核销率低于阈值（如 30%）的 SKU    | order     |
| 异常利润 SKU | 利润率过低/过高（阈值）           | order     |
| 成本缺失订单数  | cost_amount 为空 或 0 的订单 | order     |

---

### 3.3 产品看板指标（默认展示）

| 指标         | 口径/说明                     | 数据来源             |
| ---------- | ------------------------- | ---------------- |
| 待审批（本人/团队） | approver=我 且待审批           | approval         |
| 调价次数       | price_history 数量（按人/按SKU） | price_history    |
| 上下架次数      | 审计日志中 status_change       | audit_log        |
| 产品复用率      | 产品使用资源数 / 资源总数（参考）        | product_resource |

---

## 4. 报表与看板信息架构（IA）

### 4.1 菜单结构建议

* 经营看板（管理层）
* 运营看板
* 产品看板
* 报表中心

  * 销售报表
  * 利润报表
  * 核销报表
  * 渠道分析
  * SKU 分析
  * 产品分析
  * 异常报表

---

## 5. 维度体系与钻取

### 5.1 维度（Dimensions）

* 时间：日/周/月
* 渠道：channel_id（支持 parent_id 聚合到平台级）
* SKU：sku_id
* 产品：product_id

### 5.2 Drill-down（下钻）规则

* 任何看板数字必须可点击 → 跳转订单明细列表
* 订单明细支持：导出、筛选、排序

---

## 6. 统计口径与 SQL 设计（建议）

> 说明：不要求你们一定用物化视图，但建议使用“报表汇总表/物化视图”减少大表查询压力。

### 6.1 日/周/月聚合的基础视图（示例）

**按日聚合**（伪 SQL）：

```sql
SELECT
  date_trunc('day', created_at) AS day,
  channel_id,
  sku_id,
  product_id,
  COUNT(*) AS order_cnt,
  SUM(sale_amount) AS gmv,
  SUM(profit_amount) AS profit,
  SUM(CASE WHEN status='已核销' THEN 1 ELSE 0 END) AS verified_cnt,
  SUM(CASE WHEN status='已退款' THEN 1 ELSE 0 END) AS refunded_cnt,
  SUM(CASE WHEN status='已支付' THEN sale_amount ELSE 0 END) AS unpaid_verified_gmv
FROM "order"
WHERE created_at >= :start AND created_at < :end
GROUP BY 1,2,3,4;
```

**核销率/利润率**由前端或二次 SQL 计算：

* verified_rate = verified_cnt / order_cnt
* profit_rate = profit / gmv

---

### 6.2 缺库存预警（示例）

```sql
SELECT sku_id, COUNT(*) AS low_days
FROM inventory
WHERE inventory_date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '7 day'
  AND (total_qty - frozen_qty - sold_qty) <= 0
GROUP BY sku_id;
```

---

### 6.3 成本缺失订单（示例）

```sql
SELECT COUNT(*)
FROM "order"
WHERE cost_amount IS NULL OR cost_amount = 0;
```

---

## 7. 前端页面与交互设计

### 7.1 通用交互

* 时间切换：日/周/月 + 自定义时间范围
* 维度筛选：渠道（含平台/子渠道）、SKU、产品
* 图表：趋势图（近 30 天）、Top N 条形图
* 列表：排序、分页、导出

### 7.2 管理层经营看板布局建议

* 顶部 KPI 卡片：销售额、利润、订单数、核销率、利润率
* 中部：趋势图（销售额/利润/订单数）
* 下部：Top 渠道、Top SKU、Top 产品

### 7.3 运营看板布局建议

* 待办：待审批数、缺库存预警数
* 风险：异常核销、异常利润、成本缺失

---

## 8. 性能与数据一致性

### 8.1 性能建议

* `order` 表按 created_at 建索引
* 建议按月分区（后续订单量上来再做）
* 报表聚合：可用物化视图（每日刷新）

### 8.2 一致性原则

* 报表数字以订单事实为准
* 允许日更导入导致“昨天数据今天变化”，但必须可追溯

---

## 9. 导出与审计

* 所有报表支持导出 CSV
* 导出行为可写入 audit_log（可选）
* 指标口径文档化（本文件即口径源）

---

## 10. 可扩展方向（不影响一期）

* 指标中心（可配置指标与口径）
* 数据仓库 / BI 接入
* 自动日报/周报推送

---

> 设计总结：报表模块的关键不是“做得花”，而是“口径统一、能下钻、能解释”。只要订单事实层可靠，你们的经营看板就会长期可信。
