# M6 库存管理模块开发文档

> 模块定位：控制“是否能卖”的**最后一道闸门**
> 依赖关系：依赖 M4 商品（SKU）模块 + M5 定价模块
> 设计目标：库存**可控、不可超卖、状态清晰、可人工干预**

---

## 1. 模块定位与设计边界

### 1.1 模块解决的问题

* 维护 SKU 在某一时间维度下的可售数量
* 明确库存的生命周期：初始化 → 冻结 → 核销 → 扣减 / 解冻
* 防止超卖，为运营提供清晰的库存视图

### 1.2 模块不解决的问题

* 不对接供应商实时库存接口
* 不预测销量、不自动补库存
* 不参与价格计算

> 本模块只回答一个问题：**“这个 SKU 在某一天，还能不能卖？”**

---

## 2. 核心设计原则（非常关键）

1. **库存以 SKU + 日期 为最小粒度**
2. **不允许超卖**（任何情况下）
3. **库存变更必须有来源**（订单 / 人工调整）
4. 冻结、核销、退款路径清晰可追溯
5. 人工可兜底（允许手动调整，但留痕）

---

## 3. 核心概念

### 3.1 可售库存（Total）

* 运营初始化或维护的理论库存

### 3.2 冻结库存（Frozen）

* 已支付但未核销的订单占用库存

### 3.3 已售库存（Sold）

* 已完成核销、最终消耗的库存

> 关系恒成立：

```
Sold + Frozen ≤ Total
```

---

## 4. 数据模型设计（PGSQL）

### 4.1 SKU 日库存表 `inventory`

| 字段             | 类型          | 说明      |
| -------------- | ----------- | ------- |
| id             | bigint PK   | 主键      |
| sku_id         | bigint FK   | SKU     |
| inventory_date | date        | 库存日期    |
| total_qty      | int         | 总库存     |
| frozen_qty     | int         | 冻结库存    |
| sold_qty       | int         | 已核销库存   |
| status         | text        | 正常 / 锁定 |
| created_at     | timestamptz | 创建时间    |
| updated_at     | timestamptz | 更新时间    |

**约束**

* unique(sku_id, inventory_date)
* check (frozen_qty >= 0 AND sold_qty >= 0)
* check (sold_qty + frozen_qty <= total_qty)

---

### 4.2 库存变更流水表 `inventory_log`

> 所有库存变化都必须落表，不允许“静默修改”。

| 字段               | 类型          | 说明                        |
| ---------------- | ----------- | ------------------------- |
| id               | bigint PK   | 主键                        |
| sku_id           | bigint      |                           |
| inventory_date   | date        |                           |
| change_type      | text        | 初始化 / 冻结 / 解冻 / 核销 / 人工调整 |
| before_qty       | jsonb       | 变更前 {total,frozen,sold}   |
| after_qty        | jsonb       | 变更后 {total,frozen,sold}   |
| related_order_id | bigint      | 关联订单（若有）                  |
| operator         | text        | 操作人                       |
| operated_at      | timestamptz | 操作时间                      |
| remark           | text        | 备注                        |

---

## 5. 库存生命周期与状态机

### 5.1 生命周期概览

```
初始化 → 可售
           ↓
        支付成功
           ↓
         冻结
      ↙        ↘
   退款        核销
    ↓            ↓
  解冻        扣减
```

---

### 5.2 各阶段规则

* 初始化：

  * 由运营人工录入（支持批量导入）

* 冻结：

  * 支付成功后触发
  * frozen_qty +1

* 核销：

  * 核销成功
  * frozen_qty -1
  * sold_qty +1

* 退款：

  * 未核销订单退款
  * frozen_qty -1

---

## 6. 关键业务流程

### 6.1 初始化库存

1. 选择 SKU
2. 选择日期范围
3. 填写每日库存数
4. 保存

支持：

* 单日录入
* 批量区间录入
* CSV 导入

---

### 6.2 库存冻结（来自订单）

前置校验：

* 对应日期 inventory.total - frozen - sold ≥ 1

操作：

* 写 inventory_log
* 更新 inventory.frozen_qty

---

### 6.3 核销库存

* 校验 frozen_qty ≥ 1
* frozen_qty -1
* sold_qty +1
* 写 inventory_log

---

### 6.4 人工调整库存（兜底能力）

适用场景：

* 供应商临时减量
* 人工纠错

规则：

* 只能管理员/高级运营
* 必填原因
* 强制写 inventory_log

---

## 7. 前端页面与交互设计

### 7.1 页面清单

1. 库存日历视图（SKU 维度）
2. 库存列表视图（SKU + 日期）
3. 初始化 / 调整库存弹窗
4. 库存流水查看弹窗

---

### 7.2 库存日历视图（重点）

* 横轴：日期
* 展示：

  * 剩余库存（Total - Frozen - Sold）
  * 已冻结 / 已核销
* 颜色提示：

  * 库存充足 / 紧张 / 售罄

---

## 8. 缺库存预警规则

* 未来 N 天（默认 7 天）
* 剩余库存 ≤ 阈值（如 1 或 0）
* 提示给：运营 / 产品

---

## 9. 异常与边界场景

1. SKU 下架：

* 不影响已存在库存记录
* 禁止新增库存

2. 并发安全：

* 冻结/核销必须使用行级锁

3. 库存为 0：

* SKU 在对应日期不可售

---

## 10. 与其他模块的数据契约

| 模块     | 关系                      |
| ------ | ----------------------- |
| M7 订单  | 支付成功 → 冻结；核销/退款 → 扣减/解冻 |
| M9 报表  | 以 inventory_log 统计核销率   |
| M4 SKU | 上架前需初始化库存               |

---

## 11. 可扩展方向（不影响一期）

* 多库存维度（场次/房型）
* 超卖策略（当前明确不支持）
* 供应商库存同步

---

> 设计总结：库存模块的目标不是“灵活”，而是“**绝不卖多**”。只要库存逻辑是干净的，后面的订单、报表、财务就不会出大问题。
